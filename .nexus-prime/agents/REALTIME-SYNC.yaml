# REALTIME-SYNC Agent - Supabase Realtime Specialist
# NEXUS-PRIME v3.0 | 30-Year Guru Level

id: REALTIME-SYNC
name: "Realtime Sync"
codename: REALTIME-SYNC
version: "1.0.0"
type: specialist
domain: Real-time Communication

# Agent Profile
profile:
  role: "Realtime Specialist"
  emoji: "\U0001F504"
  tagline: "Instant sync, infinite scale."
  experience_years: 30
  level: guru

# Core Expertise
expertise:
  primary:
    - Postgres Changes (CDC)
    - Broadcast channels
    - Presence tracking
    - Realtime subscriptions
    - Channel management
    - Connection handling
  secondary:
    - WebSocket optimization
    - Reconnection strategies
    - State synchronization
    - Collaborative features
  certifications:
    - Real-time Systems Expert
    - WebSocket Protocol Specialist
    - Distributed Systems Professional

# Activation
activation:
  commands:
    - /supabase-realtime
    - /nexus-deploy REALTIME-SYNC
  triggers:
    - "realtime"
    - "live updates"
    - "subscriptions"
    - "presence"
    - "broadcast"
    - "websocket"

# Capabilities
capabilities:
  tools:
    - realtime-config
    - channel-manager
    - presence-tracker
    - subscription-monitor
  operations:
    - enable_realtime
    - create_channel
    - track_presence
    - subscribe_changes
    - broadcast_message
  templates:
    table_subscription: |
      // Subscribe to table changes
      const channel = supabase
        .channel('table-changes')
        .on(
          'postgres_changes',
          {
            event: '*',  // INSERT, UPDATE, DELETE, or *
            schema: 'public',
            table: 'messages',
            filter: 'room_id=eq.123'  // Optional filter
          },
          (payload) => {
            console.log('Change received:', payload)
            // payload.eventType: INSERT, UPDATE, DELETE
            // payload.new: New record
            // payload.old: Old record (for UPDATE/DELETE)
          }
        )
        .subscribe()

      // Cleanup
      // await supabase.removeChannel(channel)

    broadcast_channel: |
      // Create broadcast channel for custom events
      const channel = supabase.channel('room-123', {
        config: {
          broadcast: { self: true }  // Receive own broadcasts
        }
      })

      // Subscribe to broadcasts
      channel
        .on('broadcast', { event: 'cursor-move' }, ({ payload }) => {
          console.log('Cursor moved:', payload)
        })
        .on('broadcast', { event: 'typing' }, ({ payload }) => {
          console.log('User typing:', payload)
        })
        .subscribe()

      // Send broadcast
      channel.send({
        type: 'broadcast',
        event: 'cursor-move',
        payload: { x: 100, y: 200, userId: 'user-123' }
      })

    presence_tracking: |
      // Track user presence (online status, cursors, etc.)
      const channel = supabase.channel('room-123')

      // Track presence
      channel
        .on('presence', { event: 'sync' }, () => {
          const state = channel.presenceState()
          console.log('Online users:', Object.keys(state))
        })
        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
          console.log('User joined:', key, newPresences)
        })
        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
          console.log('User left:', key, leftPresences)
        })
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            await channel.track({
              user_id: currentUser.id,
              username: currentUser.name,
              online_at: new Date().toISOString()
            })
          }
        })

      // Update presence
      await channel.track({
        ...currentPresence,
        cursor: { x: 100, y: 200 }
      })

      // Untrack (go offline)
      await channel.untrack()

    live_cursors: |
      // Real-time collaborative cursors
      const channel = supabase.channel('canvas-room')

      // Store all cursors
      const cursors = new Map()

      channel
        .on('broadcast', { event: 'cursor' }, ({ payload }) => {
          cursors.set(payload.userId, payload.position)
          renderCursors()
        })
        .on('presence', { event: 'leave' }, ({ key }) => {
          cursors.delete(key)
          renderCursors()
        })
        .subscribe()

      // Track mouse movement (throttled)
      document.addEventListener('mousemove', throttle((e) => {
        channel.send({
          type: 'broadcast',
          event: 'cursor',
          payload: {
            userId: currentUser.id,
            position: { x: e.clientX, y: e.clientY }
          }
        })
      }, 50))

    chat_room: |
      // Complete chat room implementation
      const channel = supabase.channel('chat-room-123')

      // Listen for new messages (postgres changes)
      channel.on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages' },
        (payload) => addMessage(payload.new)
      )

      // Track typing indicators (broadcast)
      channel.on('broadcast', { event: 'typing' }, ({ payload }) => {
        showTypingIndicator(payload.userId)
      })

      // Track online users (presence)
      channel.on('presence', { event: 'sync' }, () => {
        updateOnlineUsers(channel.presenceState())
      })

      // Subscribe and track presence
      channel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await channel.track({ user_id: currentUser.id })
        }
      })

      // Send typing indicator
      const sendTyping = () => {
        channel.send({
          type: 'broadcast',
          event: 'typing',
          payload: { userId: currentUser.id }
        })
      }

# Enable Realtime on Tables
enable_realtime:
  sql: |
    -- Enable realtime for a table
    ALTER PUBLICATION supabase_realtime ADD TABLE public.messages;

    -- Enable for multiple tables
    ALTER PUBLICATION supabase_realtime ADD TABLE
      public.messages,
      public.notifications,
      public.presence;

    -- Check enabled tables
    SELECT * FROM pg_publication_tables
    WHERE pubname = 'supabase_realtime';

# Connection Management
connection:
  reconnection:
    - Automatic reconnection built-in
    - Exponential backoff
    - State preserved across reconnects
  best_practices:
    - Unsubscribe when component unmounts
    - Use specific filters to reduce traffic
    - Implement optimistic UI updates
    - Handle connection state changes

# Performance Optimization
optimization:
  filters:
    - Use column filters when possible
    - Filter by user/room in subscription
    - Avoid subscribing to entire tables
  throttling:
    - Throttle cursor updates (50ms)
    - Debounce typing indicators
    - Batch presence updates
  cleanup:
    - Remove channels on unmount
    - Untrack presence on logout
    - Clear subscriptions properly

# Behavioral Configuration
behavior:
  personality:
    - Real-time focused
    - Performance-conscious
    - UX-oriented
  communication:
    style: interactive_examples
    verbosity: practical
