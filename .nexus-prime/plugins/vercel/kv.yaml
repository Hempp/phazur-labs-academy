# ═══════════════════════════════════════════════════════════════════════════════
#  NEXUS-PRIME: Vercel KV Plugin
#  Serverless Redis-compatible key-value store
# ═══════════════════════════════════════════════════════════════════════════════

plugin:
  id: "vercel-kv"
  name: "Vercel KV"
  version: "1.0.0"
  description: "Serverless Redis-compatible key-value store for caching and sessions"
  team: "TEAM-VERCEL"
  agent: "EDGE-OPS"
  enabled: false

# Installation
installation:
  npm: "@vercel/kv"
  command: "npm install @vercel/kv"
  
  environment:
    - name: "KV_URL"
      description: "KV connection URL"
      source: "Auto-generated by Vercel"
    - name: "KV_REST_API_URL"
      description: "REST API URL"
      source: "Auto-generated by Vercel"
    - name: "KV_REST_API_TOKEN"
      description: "REST API token"
      source: "Auto-generated by Vercel"

# Features
features:
  caching:
    description: "High-performance caching"
    use_cases:
      - API response caching
      - Session storage
      - Rate limiting
  
  edge_compatible:
    description: "Works with Edge Runtime"
  
  redis_commands:
    description: "Supports common Redis commands"
    supported:
      - GET/SET/DEL
      - HGET/HSET/HDEL
      - LPUSH/RPUSH/LPOP/RPOP
      - SADD/SREM/SMEMBERS
      - INCR/DECR
      - EXPIRE/TTL

# Usage Templates
templates:
  basic: |
    import { kv } from '@vercel/kv'
    
    // Set a value
    await kv.set('user:1:name', 'John Doe')
    
    // Get a value
    const name = await kv.get('user:1:name')
    
    // Set with expiration (seconds)
    await kv.set('session:abc123', sessionData, { ex: 3600 })
  
  caching: |
    import { kv } from '@vercel/kv'
    
    async function getCachedData(key: string, fetchFn: () => Promise<any>) {
      // Try cache first
      const cached = await kv.get(key)
      if (cached) return cached
      
      // Fetch fresh data
      const data = await fetchFn()
      
      // Cache for 5 minutes
      await kv.set(key, data, { ex: 300 })
      
      return data
    }
    
    // Usage
    const posts = await getCachedData('posts:recent', async () => {
      const res = await fetch('/api/posts')
      return res.json()
    })
  
  rate_limiting: |
    import { kv } from '@vercel/kv'
    import { NextResponse } from 'next/server'
    import type { NextRequest } from 'next/server'
    
    const RATE_LIMIT = 100  // requests per window
    const WINDOW = 60      // seconds
    
    export async function middleware(request: NextRequest) {
      const ip = request.ip || 'anonymous'
      const key = `rate_limit:${ip}`
      
      const current = await kv.incr(key)
      
      if (current === 1) {
        await kv.expire(key, WINDOW)
      }
      
      if (current > RATE_LIMIT) {
        return NextResponse.json(
          { error: 'Rate limit exceeded' },
          { status: 429 }
        )
      }
      
      const response = NextResponse.next()
      response.headers.set('X-RateLimit-Remaining', String(RATE_LIMIT - current))
      
      return response
    }
  
  session_storage: |
    import { kv } from '@vercel/kv'
    import { nanoid } from 'nanoid'
    
    interface Session {
      userId: string
      email: string
      createdAt: number
    }
    
    export async function createSession(userId: string, email: string): Promise<string> {
      const sessionId = nanoid()
      const session: Session = {
        userId,
        email,
        createdAt: Date.now(),
      }
      
      await kv.set(`session:${sessionId}`, session, { ex: 86400 }) // 24 hours
      
      return sessionId
    }
    
    export async function getSession(sessionId: string): Promise<Session | null> {
      return await kv.get(`session:${sessionId}`)
    }
    
    export async function deleteSession(sessionId: string): Promise<void> {
      await kv.del(`session:${sessionId}`)
    }
  
  hash_operations: |
    import { kv } from '@vercel/kv'
    
    // Store user profile as hash
    await kv.hset('user:1', {
      name: 'John Doe',
      email: 'john@example.com',
      role: 'admin'
    })
    
    // Get single field
    const name = await kv.hget('user:1', 'name')
    
    // Get all fields
    const user = await kv.hgetall('user:1')
    
    // Update single field
    await kv.hset('user:1', { role: 'superadmin' })
